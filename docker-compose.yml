services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: tawatch-backend
    container_name: ${APP_NAME}
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "${HOST_PORT}:${SERVER_PORT}"
    environment:
      # ==== PORTS ===
      SERVER_PORT: ${SERVER_PORT}

      # === Application Settings ===
      APP_NAME: ${APP_NAME}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}

      # === Server Configuration ===
      SERVER_CONTEXT_PATH: ${SERVER_CONTEXT_PATH}
      SERVER_MAX_THREADS: ${SERVER_MAX_THREADS}
      SERVER_MIN_THREADS: ${SERVER_MIN_THREADS}
      SERVER_CONNECTION_TIMEOUT: ${SERVER_CONNECTION_TIMEOUT}
      SERVER_ACCEPT_COUNT: ${SERVER_ACCEPT_COUNT}
      SERVER_MAX_CONNECTIONS: ${SERVER_MAX_CONNECTIONS}

      # === Database Configuration ===
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_TIMEZONE: ${DB_TIMEZONE}
      DB_USE_SSL: ${DB_USE_SSL}
      DB_ALLOW_PUBLIC_KEY_RETRIEVAL: ${DB_ALLOW_PUBLIC_KEY_RETRIEVAL}
      DB_POOL_SIZE: ${DB_POOL_SIZE}
      DB_POOL_MIN_IDLE: ${DB_POOL_MIN_IDLE}
      DB_CONNECTION_TIMEOUT: ${DB_CONNECTION_TIMEOUT}
      DB_IDLE_TIMEOUT: ${DB_IDLE_TIMEOUT}
      DB_MAX_LIFETIME: ${DB_MAX_LIFETIME}
      DB_TEST_QUERY: ${DB_TEST_QUERY}

      # === Mail Configuration ===
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_SMTP_AUTH: ${MAIL_SMTP_AUTH}
      MAIL_STARTTLS_ENABLE: ${MAIL_STARTTLS_ENABLE}
      MAIL_CONNECTION_TIMEOUT: ${MAIL_CONNECTION_TIMEOUT}
      MAIL_TIMEOUT: ${MAIL_TIMEOUT}
      MAIL_WRITE_TIMEOUT: ${MAIL_WRITE_TIMEOUT}

      # === OAuth2 Google Configuration ===
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      OAUTH2_SUCCESS_URL: ${OAUTH2_SUCCESS_URL}
      OAUTH2_FAILURE_URL: ${OAUTH2_FAILURE_URL}

      # === JPA / Hibernate Settings ===
      JPA_SHOW_SQL: ${JPA_SHOW_SQL}
      HIBERNATE_DIALECT: ${HIBERNATE_DIALECT}
      HIBERNATE_SQL_COMMENTS: ${HIBERNATE_SQL_COMMENTS}
      HIBERNATE_BATCH_SIZE: ${HIBERNATE_BATCH_SIZE}
      HIBERNATE_ORDER_INSERTS: ${HIBERNATE_ORDER_INSERTS}
      HIBERNATE_ORDER_UPDATES: ${HIBERNATE_ORDER_UPDATES}

      # === Flyway Migration Settings ===
      FLYWAY_LOCATIONS: ${FLYWAY_LOCATIONS}

      # === JWT Configuration ===
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_EXPIRATION: ${JWT_ACCESS_EXPIRATION}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
      JWT_RESET_PASSWORD_EXPIRATION: ${JWT_RESET_PASSWORD_EXPIRATION}
      JWT_ISSUER: ${JWT_ISSUER}

      # === CORS Configuration ===
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS}
      CORS_MAX_AGE: ${CORS_MAX_AGE}

      # === Cache Configuration ===
      OTP_MAXIMUM_SIZE: ${OTP_MAXIMUM_SIZE}
      OTP_EXPIRE_AFTER: ${OTP_EXPIRE_AFTER}
      OTP_MAX_ATTEMPTS: ${OTP_MAX_ATTEMPTS}
      OTP_INITIAL_CAPACITY: ${OTP_INITIAL_CAPACITY}
      OTP_MAX_RESEND: ${OTP_MAX_RESEND}
      OTP_RESEND_COOLDOWN: ${OTP_RESEND_COOLDOWN}

      # === Swagger / OpenAPI ===
      SWAGGER_API_DOCS_PATH: ${SWAGGER_API_DOCS_PATH}
      SWAGGER_UI_PATH: ${SWAGGER_UI_PATH}
      SWAGGER_ENABLED: ${SWAGGER_ENABLED}
      SWAGGER_UI_ENABLED: ${SWAGGER_UI_ENABLED}
      SWAGGER_OPERATIONS_SORTER: ${SWAGGER_OPERATIONS_SORTER}
      SWAGGER_TAGS_SORTER: ${SWAGGER_TAGS_SORTER}
      SWAGGER_DISPLAY_REQUEST_DURATION: ${SWAGGER_DISPLAY_REQUEST_DURATION}
      SWAGGER_SHOW_ACTUATOR: ${SWAGGER_SHOW_ACTUATOR}

      # === Spring Boot Actuator ===
      ACTUATOR_EXPOSED_ENDPOINTS: ${ACTUATOR_EXPOSED_ENDPOINTS}
      ACTUATOR_BASE_PATH: ${ACTUATOR_BASE_PATH}
      ACTUATOR_HEALTH_SHOW_DETAILS: ${ACTUATOR_HEALTH_SHOW_DETAILS}
      ACTUATOR_HEALTH_SHOW_COMPONENTS: ${ACTUATOR_HEALTH_SHOW_COMPONENTS}
      ACTUATOR_HEALTH_DB: ${ACTUATOR_HEALTH_DB}
      ACTUATOR_HEALTH_MAIL: ${ACTUATOR_HEALTH_MAIL}

      # === Logging Configuration ===
      LOG_ROOT: ${LOG_ROOT}
      LOG_APP_LEVEL: ${LOG_APP_LEVEL}
      LOG_SPRING_WEB: ${LOG_SPRING_WEB}
      LOG_HIBERNATE_SQL: ${LOG_HIBERNATE_SQL}
      LOG_HIBERNATE_BIND: ${LOG_HIBERNATE_BIND}
      LOG_FLYWAY: ${LOG_FLYWAY}

    networks:
      - tawatch-net

  mysql:
    image: mysql:8.0.35
    container_name: tawatch-mysql
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "${DB_EXTERNAL_PORT}:3306"
    volumes:
      - tawatch_mysql_data:/var/lib/mysql
    networks:
      - tawatch-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  tawatch_mysql_data:
    name: tawatch_mysql_data

networks:
  tawatch-net: