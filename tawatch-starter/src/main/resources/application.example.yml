# ========================================================
# Tawatch Backend Configuration (Template)
# ========================================================
# This is a template configuration file. Use it as a reference
# to create environment-specific configuration files.
#
# USAGE:
# 1. Copy this file to create environment-specific configurations:
#    - application-local.yaml       (local development)
#    - application-docker.yaml      (docker environment)
#
# 2. Do NOT commit real environment files with secrets to version control.
# 3. Use environment variables or secure secret managers for sensitive data.
# ========================================================

# ========================================================
# SPRING APPLICATION CONFIGURATION
# ========================================================
spring:
  # --- Application Metadata ---
  application:
    # Used in logs, metrics, and service discovery
    name: ${APP_NAME:tawatch}       # Application name

  # ========================================================
  # DATABASE CONFIGURATION (MySQL)
  # ========================================================
  datasource:
    # Database connection URL with environment variable support
    # Format: jdbc:mysql://host:port/database
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:tawatch_db}

    # Database credentials (use environment variables in production)
    username: ${DB_USERNAME:tawatch_user}  # Database username
    password: ${DB_PASSWORD:password}      # Database password

    # JDBC driver class for MySQL
    driver-class-name: com.mysql.cj.jdbc.Driver

    # Hikari Connection Pool Configuration
    hikari:
      # Maximum number of connections in the pool
      maximum-pool-size: ${DB_POOL_SIZE:10}

      # Minimum number of idle connections in the pool
      minimum-idle: ${DB_POOL_MIN_IDLE:5}

      # Maximum time (ms) to wait for a connection from the pool
      connection-timeout: ${DB_CONNECTION_TIMEOUT:30000}

      # Maximum time (ms) a connection can remain idle in the pool
      idle-timeout: ${DB_IDLE_TIMEOUT:600000}

      # Maximum lifetime (ms) of a connection in the pool
      max-lifetime: ${DB_MAX_LIFETIME:1800000}

      # Query to test database connection validity
      connection-test-query: ${DB_TEST_QUERY:SELECT 1}

      # Advanced data source properties
      data-source-properties:
        # Timezone configuration for database connections
        serverTimezone: ${DB_TIMEZONE:Asia/Ho_Chi_Minh}

        # SSL/TLS configuration for database connection
        useSSL: ${DB_USE_SSL:false}        # Enable/disable SSL encryption

        # Allow retrieving public key for authentication
        allowPublicKeyRetrieval: ${DB_ALLOW_PUBLIC_KEY_RETRIEVAL:true}

  # ========================================================
  # JPA / HIBERNATE CONFIGURATION
  # ========================================================
  jpa:
    # Schema generation strategy:
    # - validate:    Validate schema, make no changes (recommended for production and Flyway)
    # - update:      Update the schema
    # - create:      Create the schema, destroying previous data
    # - create-drop: Create then drop the schema when SessionFactory closes
    # - none:        Disable DDL handling
    hibernate:
      ddl-auto: validate

    # Enable SQL query logging to console (disable in production)
    show-sql: ${JPA_SHOW_SQL:false}

    # Hibernate-specific properties
    properties:
      hibernate:
        # Format SQL for better readability in logs
        format_sql: true

        # SQL dialect for MySQL 8
        dialect: ${HIBERNATE_DIALECT:org.hibernate.dialect.MySQL8Dialect}

        # Add comments to generated SQL for debugging
        use_sql_comments: ${HIBERNATE_SQL_COMMENTS:true}

        # JDBC batch processing configuration
        jdbc:
          batch_size: ${HIBERNATE_BATCH_SIZE:20}           # Number of statements per batch
          order_inserts: ${HIBERNATE_ORDER_INSERTS:true}   # Optimize insert ordering
          order_updates: ${HIBERNATE_ORDER_UPDATES:true}   # Optimize update ordering

  # ========================================================
  # FLYWAY DATABASE MIGRATION CONFIGURATION
  # ========================================================
  flyway:
    enabled: true                           # Enable Flyway database migrations

    # Create baseline for existing databases (when first introducing Flyway)
    baseline-on-migrate: true

    # Location of migration scripts (classpath directory)
    locations: ${FLYWAY_LOCATIONS:classpath:db/migration}

    # Validate migration checksums before applying migrations
    validate-on-migrate: true

    # Disallow out-of-order migrations for safety
    out-of-order: false

    # Disable clean command to prevent accidental data loss
    clean-disabled: true

# ========================================================
# SERVER CONFIGURATION
# ========================================================
server:
  # HTTP server port (override with SERVER_PORT environment variable)
  port: ${SERVER_PORT:8080}

  # Tomcat server thread pool configuration
  tomcat:
    threads:
      # Maximum number of worker threads
      max: ${SERVER_MAX_THREADS:200}

      # Minimum number of worker threads (always kept alive)
      min-spare: ${SERVER_MIN_THREADS:20}

    # Maximum number of connections that the server will accept and process
    max-connections: ${SERVER_MAX_CONNECTIONS:1000}

    # Maximum queue length for incoming connection requests when all threads are busy
    accept-count: ${SERVER_ACCEPT_COUNT:100}

    # Connection timeout (milliseconds)
    connection-timeout: ${SERVER_CONNECTION_TIMEOUT:5000}

  servlet:
    # Base context path for all API endpoints
    context-path: ${SERVER_CONTEXT_PATH:/api/tawatch}

    # Character encoding configuration
    encoding:
      charset: UTF-8               # Character encoding for requests/responses
      enabled: true                # Enable encoding filter
      force: true                  # Force encoding even if header specifies different

  # Error response configuration
  # Disable default Spring Boot error details because we use custom standardized error responses
  error:
    include-message: never         # Don't include exception message in default error response
    include-binding-errors: never  # Don't include binding errors in default error response
    include-stacktrace: never      # Don't include stack trace in default error response

# ========================================================
# APPLICATION CUSTOM CONFIGURATION
# ========================================================
application:
  # ========================================================
  # SECURITY CONFIGURATION
  # ========================================================
  security:
    # JWT (JSON Web Token) Authentication Configuration
    jwt:
      # JWT secret key for signing and verifying tokens
      # WARNING: MUST be changed to a strong, random value in production!
      # Minimum recommended length: 256 bits (32 characters)
      secret: ${JWT_SECRET:ChangeThisJWTSecretInProduction}

      # Access token configuration
      access:
        # Access token expiration duration (ISO-8601 Duration format)
        # Format: PT[hours]H[minutes]M[seconds]S
        # Examples: PT15M (15 minutes), PT1H (1 hour), PT30M (30 minutes)
        # Recommended: Short-lived (5-15 minutes) for better security
        expiration: ${JWT_ACCESS_EXPIRATION:PT10M}

      # Refresh token configuration
      refresh:
        # Refresh token expiration duration (ISO-8601 Duration format)
        # Format: P[days]D or PT[hours]H
        # Examples: P7D (7 days), P30D (30 days), PT24H (24 hours)
        # Recommended: Longer-lived (7-30 days) to avoid frequent re-authentication
        expiration: ${JWT_REFRESH_EXPIRATION:P7D}

      # Reset password token configuration
      reset-password:
        # Reset password token expiration duration (ISO-8601 Duration format)
        # Format: PT[hours]H[minutes]M
        # Examples: PT15M (15 minutes), PT30M (30 minutes), PT1H (1 hour)
        # Recommended: Short-lived (15-30 minutes) for security
        expiration: ${JWT_RESET_PASSWORD_EXPIRATION:PT15M}

      # JWT issuer identifier (appears in 'iss' claim)
      # Used to identify the system that issued the token
      issuer: ${JWT_ISSUER:TAwatch-System}

  # ========================================================
  # CORS (Cross-Origin Resource Sharing) CONFIGURATION
  # ========================================================
  cors:
    # Allowed origins for CORS requests
    # Format: Comma-separated list of origins (URLs)
    # Examples:
    #   - Single origin: https://example.com
    #   - Multiple origins: https://example.com,https://app.example.com
    #   - Allow all (NOT recommended in production): *
    # WARNING: Never use '*' in production when credentials are enabled!
    allowed-origins: ${CORS_ALLOWED_ORIGINS:https://yourdomain}

    # Allowed HTTP methods for CORS requests
    # Format: Comma-separated list of HTTP methods
    # Common methods: GET, POST, PUT, DELETE, PATCH, OPTIONS
    allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS,PATCH}

    # Allowed headers in CORS requests
    # Format: Comma-separated list of headers or '*' for all headers
    # Examples: Authorization,Content-Type,X-Requested-With
    # Note: '*' allows all headers
    allowed-headers: ${CORS_ALLOWED_HEADERS:*}

    # Allow credentials (cookies, authorization headers) in CORS requests
    # Set to 'true' if frontend needs to send cookies or auth headers
    # WARNING: When 'true', allowed-origins MUST NOT be '*'
    allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}

    # Maximum age (duration) for caching CORS preflight requests
    # Format: ISO-8601 Duration format (PT[hours]H or PT[minutes]M)
    # Examples: PT1H (1 hour), PT30M (30 minutes)
    # Browsers cache preflight response for this duration
    max-age: ${CORS_MAX_AGE:PT1H}

  # ========================================================
  # CACHE CONFIGURATION
  # ========================================================
  cache:
    # OTP (One-Time Password) Cache Configuration
    # Used for storing and managing OTP codes for authentication
    otp:
      # Maximum number of OTP entries that can be stored in the cache
      # Once this limit is reached, least recently used entries are evicted
      maximum-size: ${OTP_MAXIMUM_SIZE:10000}

      # Time duration after which an OTP entry expires and is automatically removed
      # Format: ISO-8601 Duration format (PT[minutes]M or PT[seconds]S)
      # Examples: PT5M (5 minutes), PT10M (10 minutes), PT30S (30 seconds)
      # Recommended: 5-10 minutes for security
      expire-after-write: ${OTP_EXPIRE_AFTER:PT5M}

      # Maximum number of failed verification attempts allowed per OTP
      # After exceeding this limit, the OTP is invalidated
      # Recommended: 3-5 attempts to prevent brute-force attacks
      max-attempts: ${OTP_MAX_ATTEMPTS:5}

      # Initial capacity of the cache (optimization for memory allocation)
      # Should be set based on expected concurrent OTP requests
      initial-capacity: ${OTP_INITIAL_CAPACITY:100}

      # Maximum number of times an OTP can be resent to the same user
      # Prevents abuse and spam
      max-resend: ${OTP_MAX_RESEND:3}

      # Cooldown period between OTP resend requests
      # Format: ISO-8601 Duration format (PT[minutes]M or PT[seconds]S)
      # Examples: PT1M (1 minute), PT2M (2 minutes), PT30S (30 seconds)
      # Prevents rapid resend spam
      resend-cooldown: ${OTP_RESEND_COOLDOWN:PT1M}

# ========================================================
# SPRINGDOC OPENAPI / SWAGGER CONFIGURATION
# ========================================================
springdoc:
  # OpenAPI documentation configuration
  api-docs:
    # Path to OpenAPI documentation endpoint (JSON format)
    path: ${SWAGGER_API_DOCS_PATH:/v3/api-docs}

    # Enable OpenAPI documentation generation (should be 'false' in production)
    enabled: ${SWAGGER_ENABLED:false}

  # Swagger UI configuration
  swagger-ui:
    # Path to Swagger UI interface
    path: ${SWAGGER_UI_PATH:/swagger-docs}

    # Enable Swagger UI interface (should be 'false' in production)
    enabled: ${SWAGGER_UI_ENABLED:false}

    # Sort operations by HTTP method (alpha, method)
    operations-sorter: ${SWAGGER_OPERATIONS_SORTER:method}

    # Sort tags alphabetically
    tags-sorter: ${SWAGGER_TAGS_SORTER:alpha}

    # Display request duration in Swagger UI
    display-request-duration: ${SWAGGER_DISPLAY_REQUEST_DURATION:true}

    # Show Spring Boot Actuator endpoints in Swagger UI (should be 'false' in production)
  show-actuator: ${SWAGGER_SHOW_ACTUATOR:false}

# ========================================================
# SPRING BOOT ACTUATOR CONFIGURATION
# ========================================================
management:
  # Actuator endpoints configuration
  endpoints:
    web:
      # Base path for actuator endpoints
      base-path: ${ACTUATOR_BASE_PATH:/actuator}

      # Comma-separated list of exposed actuator endpoints
      exposure:
        include: ${ACTUATOR_EXPOSED_ENDPOINTS:health,info}

  # Health endpoint configuration
  endpoint:
    health:
      # Show detailed health information (always, when-authorized, never)
      # Recommended: 'when-authorized' in production
      show-details: ${ACTUATOR_HEALTH_SHOW_DETAILS:when-authorized}

      # Show health component details (always, when-authorized, never)
      # Recommended: 'when-authorized' in production
      show-components: ${ACTUATOR_HEALTH_SHOW_COMPONENTS:when-authorized}

  # Health indicators configuration
  health:
    # Database health check
    db:
      enabled: ${ACTUATOR_HEALTH_DB:true}

    # Mail health check (if mail is configured)
    mail:
      enabled: ${ACTUATOR_HEALTH_MAIL:true}

# ========================================================
# LOGGING CONFIGURATION
# ========================================================
logging:
  level:
    # Root logger level (affects all logs unless overridden)
    root: ${LOG_ROOT:INFO}

    # Application-specific logging (package: vn.fernirx.tawatch)
    vn.fernirx.tawatch: ${LOG_APP_LEVEL:DEBUG}

    # Spring Web logging level
    org.springframework.web: ${LOG_SPRING_WEB:DEBUG}

    # Hibernate SQL logging - shows executed SQL statements
    org.hibernate.SQL: ${LOG_HIBERNATE_SQL:DEBUG}

    # Hibernate parameter binding logging - shows query parameter values
    # WARNING: Setting to TRACE may expose sensitive data in logs
    org.hibernate.type.descriptor.sql.BasicBinder: ${LOG_HIBERNATE_BIND:TRACE}

    # Flyway migration logging
    org.flywaydb: ${LOG_FLYWAY:DEBUG}